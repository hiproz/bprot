# 目标
此文档旨在建议一种简单，高效，可扩展的使用于硬件和服务器之间的二进制协议。

# 协议包结构

请求消息：

| 字段     | 起始符 | 校验 | 内容长度 | 数据包类型 | 请求序列号SN |发送方ID  | 时间 | 消息内容 | 结束符  | 
| ----    | -----  | ----| ----    | ----      | ----        | ----    | ---- | ----    | ----   |
| 字节长度 | 2      | 2   | 2       | 2         | 4           | 8       | 6    | N       | 2      |

响应消息：

| 字段     | 起始符 | 校验 | 内容长度 | 数据包类型 | 响应序列号SN |发送方ID  | 时间 | 消息内容 | 结束符  | 
| ----    | -----  | ----| ----    | ----      | ----        | ----    | ---- | ----    | ----   |
| 字节长度 | 2      | 2   | 2       | 2         | 4           | 8       | 6    | N       | 2      |

1.	起始符：0xFFFF
2.	校验：从长度到内容结束，不包含结束符。采用crc16校验算法
3.	长度：内容的长度
4.	数据包类型：消息类型，建议0x0101，高位主类型，低位次类型，支持一类消息下的，细微调整和变更
6.	序列号：请求方开机从0开始，递增。响应方将请求消息的序列号原样返回。
7.	时间：年月日时分秒 ，6个字节
8.	消息内容：每个消息类型有自己独立的数据内容，见下面的消息结构
9.	结束符：0xEEEE

# 约定
1.	请求消息类型是偶数，响应消息类型是请求类型加1是基数
2.	每个数据包需要携带发送方的UID（unique ID），对于硬件UID可以是IMEI，MAC，生产序列号等。对于服务器，UID建议用IP（byte数组）
3.	响应中的sn是将请求中的sn原样返回。
4.	时间为发送方本地RTC时钟，如果本地没有RTC，可以留空
5.	每一种消息，发送方既可以是终端，也可以是服务器，只能通过消息中的UID判断。也就是说一种消息，既可以是设备请求服务器，也可以是服务器请求设备，只要双方遵循此协议就可以。

# 数据类型规格
我们对常用的数据类型做规格定义，统一类型长度。


# 消息内容
因为消息类型的结构多样化，markdown不支持复杂表格，所以消息内容的字节结构将通过c语言风格的结构体定义来说明。
## 注册包 0x0100
## 登录包 0x0200
## 心跳包 0x0300
## GPS包 0x0400
### 请求结构 0x0400
typedef struct {
  uint8_t sat_num;
  uint8_t loc_prop;
  uint32_t lat;
  uint32_t lng;
  uint16_t speed;
} bpk_gps_struct;

typedef struct {
  uint8_t loc_num;
  bpk_gps_struct gps[BPK_MAX_GPS_LOC_NUM];
} bpk_gps_req_struct;

字段说明：
loc_num：位置包的个数，支持多包传输。
sat_num：当前包中的定位结果的有效gps数
loc_prop：位置属性，通过bit表示：

| 7     | 6    |   5 |    4 |    3 | 2    |1     | 0    |  
| ----  | -    | ----| ---- | ---- | ---- | ---- | ---- | 
|   NC  |  NC  |  NC |  NC  |见描述 |见描述 |东/西 |南/北  | 

0bit:  0  南纬 1 北纬
1bit:  0  西经 1东经
3:2bit：
00：实时
01：差分
10：估算
11：无效
如果是实时、差分或者估算，说明gps已经成功定位。
lat：纬度的 uint 表示值。纬度值为度分的整数表示 ddmm.mmmm×10000。实际数值为上报数据除以10000 ，得到纬度的度分表示法
lng：经度度的 uint 表示值，转换方法同纬度。
speed：单位 km/h，上报上来的是乘以100以后的整数值, 除以100得到实际值。 
### 响应结构 0x0401
uint32_t ret_code;
响应内容就一个响应码，最大支持4字节uint型：
0x00: 成功
001：格式错误
...
其他：服务器错误，除了定义的设备错误，其他都是服务器错误。这里可以直接返回服务器的错误码。
### 数据样例
none
## 基站包 0x0402
### 请求结构
### 响应结构
### 数据样例
none
## WIFI包 0x0404
### 请求结构
### 响应结构
### 数据样例
none

